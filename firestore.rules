/**
 * @file firestore.rules
 * @description Firestore Security Rules for an educational content platform.
 *
 * @section Core Philosophy
 * This ruleset establishes a "Public Read, User-Specific Write" security model.
 * Educational content is public, while user profiles can only be created by their respective owners.
 *
 * @section Data Structure
 * - /users/{userId}
 * - /classes/{classId}
 *   - /subjects/{subjectId}
 *     - /lessons/{lessonId}
 *       - /contents/{contentId}
 *
 * @section Key Security Decisions
 * 1.  Public Read Access: All educational content is publicly readable.
 * 2.  User Profile Creation: Any user can create their own profile document in the '/users' collection.
 *     This is essential for the registration process. Subsequent updates or reads would require specific rules.
 * 3.  Default Write Denial: All other write operations are denied by default for security.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow Any user (newly registering) can create their own user document.
     * @deny Reading, updating, or deleting user documents is disallowed by default.
     */
    match /users/{userId} {
      allow create: if true;
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;
    }

    /**
     * @description Controls access to the top-level 'classes' collection.
     * @path /classes/{classId}
     * @allow Any user can read classes. Writes are disallowed.
     */
    match /classes/{classId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Controls access to the 'subjects' subcollection.
     * @path /classes/{classId}/subjects/{subjectId}
     * @allow Any user can read subjects. Writes are disallowed.
     */
    match /classes/{classId}/subjects/{subjectId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Controls access to the 'lessons' subcollection.
     * @path /classes/{classId}/subjects/{subjectId}/lessons/{lessonId}
     * @allow Any user can read lessons. Writes are disallowed.
     */
    match /classes/{classId}/subjects/{subjectId}/lessons/{lessonId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Controls access to the 'contents' subcollection.
     * @path /classes/{classId}/subjects/{subjectId}/lessons/{lessonId}/contents/{contentId}
     * @allow Any user can read content. Writes are disallowed.
     */
    match /classes/{classId}/subjects/{subjectId}/lessons/{lessonId}/contents/{contentId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
  }
}

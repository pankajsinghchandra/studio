/**
 * @file firestore.rules
 * @description Firestore Security Rules for a public-facing educational content platform.
 *
 * @section Core Philosophy
 * This ruleset establishes a "Public Read-Only" security model. The primary goal is to
 * make all educational content (Classes, Subjects, Lessons, Content) universally
 * accessible for reading by any user, including anonymous visitors. All write
 * operations (create, update, delete) are explicitly disabled by default as a
 * security measure, because the current data model does not include any concept of
 * user ownership or administrative roles. To enable writes, the data schemas must
 * be updated to include an ownership field (e.g., 'creatorId' or 'adminId').
 *
 * @section Data Structure
 * The data is organized hierarchically to reflect the educational structure:
 * - /classes/{classId}
 *   - /subjects/{subjectId}
 *     - /lessons/{lessonId}
 *       - /contents/{contentId}
 *
 * @section Key Security Decisions
 * 1.  Public Read Access: All collections and their documents are publicly readable
 *     via `get` and `list` operations to support the app's function as an open
 *     content repository.
 * 2.  Default Write Denial: All write operations are denied (`if false;`). This
 *     creates a secure, read-only state. Placeholders and comments are provided
 *     to guide developers on how to securely enable writes once an ownership model
 *     is implemented in the application's data entities.
 * 3.  No Data Validation: In line with the prototyping philosophy, these rules
 *     do not enforce data shapes or field types. Validation is focused solely on
 *     authorization.
 *
 * @section Denormalization for Authorization
 * The data model correctly denormalizes parent IDs (e.g., `classId`, `subjectId`)
 * into child documents. While not leveraged in this initial read-only ruleset,
 * this is a critical practice that will simplify future security rules by avoiding
 * slow and costly cross-document `get()` calls when implementing write permissions.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    // -------------------------------------------------------------------------
    // Collection Rules
    // -------------------------------------------------------------------------

    /**
     * @description Controls access to the top-level 'classes' collection.
     * @path /classes/{classId}
     * @allow Any user, authenticated or not, can `get` or `list` all classes.
     * @deny Any user attempting to `create`, `update`, or `delete` a class.
     * @principle Provides public read access. Writes are disabled until an admin/ownership model is defined.
     */
    match /classes/{classId} {
      allow get, list: if true;

      // CRITICAL: Cannot implement owner-only writes. The 'Class' entity is missing an 'ownerId' or 'creatorId' field.
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field. (e.g., `request.resource.data.creatorId == request.auth.uid`)
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field. (e.g., `resource.data.creatorId == request.auth.uid`)
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field. (e.g., `resource.data.creatorId == request.auth.uid`)
    }

    /**
     * @description Controls access to the 'subjects' subcollection within each class.
     * @path /classes/{classId}/subjects/{subjectId}
     * @allow Any user, authenticated or not, can `get` or `list` all subjects for any class.
     * @deny Any user attempting to `create`, `update`, or `delete` a subject.
     * @principle Provides public read access. Writes are disabled until an admin/ownership model is defined.
     */
    match /classes/{classId}/subjects/{subjectId} {
      allow get, list: if true;

      // CRITICAL: Cannot implement owner-only writes. The 'Subject' entity is missing an 'ownerId' or 'creatorId' field.
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Controls access to the 'lessons' subcollection within each subject.
     * @path /classes/{classId}/subjects/{subjectId}/lessons/{lessonId}
     * @allow Any user, authenticated or not, can `get` or `list` all lessons for any subject.
     * @deny Any user attempting to `create`, `update`, or `delete` a lesson.
     * @principle Provides public read access. Writes are disabled until an admin/ownership model is defined.
     */
    match /classes/{classId}/subjects/{subjectId}/lessons/{lessonId} {
      allow get, list: if true;

      // CRITICAL: Cannot implement owner-only writes. The 'Lesson' entity is missing an 'ownerId' or 'creatorId' field.
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Controls access to the 'contents' subcollection within each lesson.
     * @path /classes/{classId}/subjects/{subjectId}/lessons/{lessonId}/contents/{contentId}
     * @allow Any user, authenticated or not, can `get` or `list` all content for any lesson.
     * @deny Any user attempting to `create`, `update`, or `delete` a piece of content.
     * @principle Provides public read access. Writes are disabled until an admin/ownership model is defined.
     */
    match /classes/{classId}/subjects/{subjectId}/lessons/{lessonId}/contents/{contentId} {
      allow get, list: if true;

      // CRITICAL: Cannot implement owner-only writes. The 'Content' entity is missing an 'ownerId' or 'creatorId' field.
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }
  }
}